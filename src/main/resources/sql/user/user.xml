<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.project_03.user.UserMapper">

    <select id="emailChk" parameterType="java.util.Map">
        select * from user where email=#{email}
    </select>

    <select id="nicknameChk" parameterType="java.util.Map">
        select * from user where nickname=#{nickname}
    </select>

    <insert id="insertMember" parameterType="java.util.Map">
        INSERT INTO USER (email, nickname, password)
        VALUES (#{email}, #{nickname}, #{encodedPassword})
    </insert>


    <insert id="insertDelivery" parameterType="java.util.Map">
        INSERT INTO deliver (user_email, place, name, phone, postcode, address, detail_address)
        VALUES (#{email}, #{title}, #{name}, #{phone1}, #{postCode}, #{roadAddr}, #{detailAddr})
    </insert>


    <insert id="insertMemberTerm" parameterType="java.util.Map">
        INSERT INTO USER_TERM (user_email, term_id)
        VALUES
        <foreach collection="status" item="termId" separator=",">
            (#{email}, #{termId})
        </foreach>
    </insert>

   <update id="changePwd">
       UPDATE USER SET password=#{encodedPassword2} where email=#{email}
  </update>

    <select id="selectProductDetail" parameterType="java.util.Map">
        SELECT
        p.id,
        p.name,
        p.price,
        p.rate,
        p.stock_quantity,
        p.content,
        pi.file_name
        <if test="email != null || email != ''">
            , CASE
            WHEN likes.product_id IS NOT NULL THEN 'liked'
            ELSE 'not liked'
            END AS like_status,
            CASE
            WHEN carts.product_id IS NOT NULL THEN 'carted'
            ELSE 'not carted'
            END AS cart_status,
            COALESCE(carts.cart_count, 0) AS cart_count
        </if>
        FROM
        product p
        JOIN product_image pi ON p.id = pi.product_id
        <if test="email != null || email != ''">
            LEFT JOIN likes ON p.id = likes.product_id AND likes.user_email = #{email}
            LEFT JOIN carts ON p.id = carts.product_id AND carts.user_email = #{email}
        </if>
        WHERE p.id = ${product_no}
    </select>

    <select id="selectCartList" parameterType="java.util.Map">
        SELECT
            pi.file_name,
            p.price,
            p.stock_quantity,
            p.rate,
            p.name,
            p.id,
            c.cart_count
        FROM
            carts c
                JOIN product p ON c.product_id = p.id
                JOIN product_image pi ON p.id = pi.product_id
        WHERE
            c.user_email = '${email}'
    </select>

    <select id="countCarted" resultType="java.util.Map">
        SELECT
            COUNT(*) AS carted_count
        FROM carts
        where user_email = '${email}'
    </select>

    <select id="selectFirstCart" resultType="java.util.Map">
        SELECT
        p.name,
        pi.file_name
    FROM product p
    JOIN product_image pi ON p.id = pi.product_id
        where p.id = ${firstProductId}
    </select>


    <select id="selectCheckboxCartList" resultType="java.util.Map">
        SELECT p.id, pi.file_name, p.name, p.price, c.cart_count, p.rate
        FROM product p
        INNER JOIN product_image pi ON p.id = pi.product_id
        INNER JOIN carts c ON p.id = c.product_id
        WHERE c.user_email = #{email}
        <!-- checkbox 리스트의 값을 동적으로 바인딩 -->
        <foreach collection="checkbox" item="productId" open="AND p.id IN (" close=")" separator=",">
            #{productId}
        </foreach>
    </select>


    <select id="selectBasicDeliver" parameterType="java.util.Map">
        select * from deliver where user_email=#{email} and place='우리집(기본배송지)'
    </select>

    <select id="selectDeliverList" parameterType="java.util.Map">
        SELECT * FROM deliver
        WHERE user_email = #{email}
          AND place != '우리집(기본배송지)'
    </select>

    <select id="selectDelivery" parameterType="java.util.Map">
        SELECT * FROM deliver
        WHERE user_email = #{email}
          AND place = #{selectedValue}
    </select>



</mapper>